# üáµüáπ Anki Portuguese Automation ‚Äî Unified README (2025 refresh)
*Updated: 2025-10-21*

End‚Äëto‚Äëend system to **capture vocabulary on any Apple device (iPhone / iPad / MacBook)** ‚Üí **enrich & translate (pt‚ÄëPT, C1+)
** ‚Üí **auto‚Äëload into Anki** via **OpenAI (new SDK)** and **AnkiConnect**.  

---
## üß≠ What this does (in 30 seconds)
- You **add** English or Portuguese words/phrases from any device.
- They‚Äôre **appended** to a single **iCloud JSONL inbox**:
  ```
  /Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/inbox/quick.jsonl
  ```
- A pipeline script **normalizes, deduplicates, and enriches** items using OpenAI, producing **pt‚ÄëPT C1+ example sentences**.
- Notes are inserted into Anki (Deck: **Portuguese (pt‚ÄëPT)**, Model: **GPT Vocabulary Automater**) through **AnkiConnect**.
- Logs, CSVs, and archives are kept alongside the inbox for traceability.

---

## üìÅ Folder layout (canonical)
> We standardize on **Mobile Documents/com~apple~CloudDocs** per your preference and because Shortcuts/iOS reliably writes there.

```
Portuguese/
  Anki/
    inbox/
      quick.jsonl              # append‚Äëonly JSONL inbox (single source of truth)
      fragments/*.json(l)      # optional one‚Äëoffs (merged if present)
    out/
      sayings.csv              # latest CSV ready for Anki import (also used for audits)
      archive/                 # timestamped CSV/JSONL snapshots
    logs/
      autorun.out.log          # last pipeline run
      *.err.log                # failures, if any
    scripts/
      run_pipeline.sh
      transform_inbox_to_csv.py
      merge_inbox.sh           # optional, no‚Äëop if absent
    launchd/
      com.anki.sync.quickjsonl.plist
```

---

## üß© Data contract (JSONL inbox)
Each line in `quick.jsonl` is a **valid JSON object** with this schema (kept from your earlier spec):

```json
{
  "ts": "2025-10-16 09:30:00",
  "src": "ios|ipad|mac|quick",
  "entries": "word1, word2, word3"
}
```
**Notes**
- `entries` is a **comma‚Äëseparated string**; the transformer splits, trims, lowercases, and dedupes per run.
- You may also push **single‚Äëword lines** (same schema, one word). The merger tolerates both patterns.
- The pipeline ignores **empty** or **non‚Äëalphabetic** tokens and logs them.

---

## üÉè Anki deck & model
- **Deck**: `Portuguese (pt‚ÄëPT)`  
- **Model**: `GPT Vocabulary Automater` with fields:
  - `word_en`, `word_pt`, `sentence_pt`, `sentence_en`, `date_added`
- **Audio (in Anki template, not CSV)**:  
  Add TTS in your card template so audio is **generated by Anki**, not the pipeline:
  ```
  {{tts pt_PT voices=Joana:sentence_pt}}
  ```
- **Duplicate policy**: The pipeline checks existing notes (via AnkiConnect) and **skips** exact‚Äëmatch duplicates. (Optionally, we can enable ‚Äúupdate‚Äëin‚Äëplace‚Äù later.)

---

## üõ†Ô∏è Requirements
- **macOS** with Anki installed and **AnkiConnect** add‚Äëon.
- **Python 3.12+** with the **OpenAI new SDK** available.
- **OPENAI_API_KEY** exported in your shell profile.
- iCloud Drive enabled across **iPhone / iPad / MacBook** (same Apple ID).

---

## ‚öôÔ∏è Install & configure (MacBook)
1. **Clone / place** your project:
   ```bash
   cd ~/anki-tools
   # ensure scripts/transform_inbox_to_csv.py exists here
   ```
2. **Create iCloud dirs** (idempotent):
   ```bash
   mkdir -p "/Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/inbox"             "/Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/out"             "/Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/logs"             "/Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/launchd"
   ```
3. **Export env vars** (e.g., in `~/.zshrc`):
   ```bash
   export OPENAI_API_KEY="sk-..."
   export ANKI_BASE="/Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki"
   export OPENAI_MODEL="gpt-5-thinking"   # default; set to a higher‚Äëquality model for C1+ output
   ```
4. **Install AnkiConnect** (in Anki: Tools ‚Üí Add‚Äëons ‚Üí Get Add‚Äëons ‚Üí 2055492159).

---

## ‚ñ∂Ô∏è Run manually (two options)
### A) One‚Äëliner (system Python path from your earlier spec)
```bash
/Library/Frameworks/Python.framework/Versions/3.12/bin/python3   ~/anki-tools/scripts/transform_inbox_to_csv.py   --deck "Portuguese (pt-PT)" --model "GPT Vocabulary Automater"
```

### B) Full pipeline runner (recommended)
```bash
bash ~/anki-tools/scripts/run_pipeline.sh
```
What it does:
- Opens Anki if needed (`open -gj -a "Anki"`), waits briefly.
- Optionally runs `merge_inbox.sh` (safe if missing).
- Validates API key and `ANKI_BASE`.
- Transforms ‚Üí CSV, calls AnkiConnect `canAddNotes` then `addNotes`.
- Writes logs to `$ANKI_BASE/logs` and snapshots to `$ANKI_BASE/out`.

---

## üîÅ Automate on macOS (launchd)
Create `~/anki-tools/launchd/com.anki.sync.quickjsonl.plist` with (example: daily at 09:00):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key><string>com.anki.sync.quickjsonl</string>
  <key>ProgramArguments</key>
  <array>
    <string>/bin/bash</string>
    <string>/Users/koossimons/anki-tools/scripts/run_pipeline.sh</string>
  </array>
  <key>StartCalendarInterval</key>
  <dict><key>Hour</key><integer>9</integer><key>Minute</key><integer>0</integer></dict>
  <key>StandardOutPath</key><string>{{$HOME}}/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/logs/autorun.out.log</string>
  <key>StandardErrorPath</key><string>{{$HOME}}/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/logs/autorun.err.log</string>
  <key>RunAtLoad</key><true/>
</dict>
</plist>
```
Load it:
```bash
launchctl unload ~/anki-tools/launchd/com.anki.sync.quickjsonl.plist 2>/dev/null || true
launchctl load   ~/anki-tools/launchd/com.anki.sync.quickjsonl.plist
```

---

## üì≤ Add words from **iPhone / iPad** (Apple Shortcuts)
> Goal: **append** one JSON line into `quick.jsonl` reliably (no new files, no overwrites).

**Build a Shortcut** ‚ÄúAdd to Anki Inbox‚Äù with these actions, in order:

1. **Ask for Input** ‚Üí Prompt: ‚ÄúWord(s) ‚Äî comma‚Äëseparated‚Äù; Input Type: Text ‚Üí **Result** = *UserWords*
2. **Current Date** ‚Üí Format: `yyyy-MM-dd HH:mm:ss` ‚Üí **Result** = *Now*
3. **Text** ‚Üí Content (replace placeholders with the Shortcut variables *Now* and *UserWords*):
   ```
   {{"ts":"<Now>","src":"ios","entries":"<UserWords>"}}
   ```
4. **Get File** ‚Üí Path:
   ```
   /Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/inbox/quick.jsonl
   ```
   Options: *If file is not found* ‚Üí **Create**
5. **Append to File** ‚Üí File: (use output of **Get File**) ‚Üí Text: (use **Text** from step 3) **followed by a newline** `\n`  
   Tip: Insert an extra **Text** action containing **just** a newline and append both in sequence if your iOS version strips trailing newlines.
6. (Optional) **Show Result** ‚Üí ‚ÄúAdded: <UserWords>‚Äù

**Why this works**: ‚ÄúGet File‚Äù returns the **same file** object; ‚ÄúAppend to File‚Äù keeps the handle and avoids creating ‚Äúquick (1).jsonl‚Äù.

> For iPad: identical steps. For Dictation, set step 1 to ‚ÄúDictate Text‚Äù instead of ‚ÄúAsk for Input‚Äù.

---

## ‚å®Ô∏è Add words from **MacBook**
- **Quick function** (append one line safely):
  ```bash
  add_vocab() {{
    local words="$*"
    local ts="$(date '+%Y-%m-%d %H:%M:%S')"
    local f="/Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki/inbox/quick.jsonl"
    mkdir -p "$(dirname "$f")"
    printf '{{"ts":"%s","src":"mac","entries":"%s"}}\n' "$ts" "$words" >> "$f"
    echo "Added ‚Üí $words"
  }}
  # usage: add_vocab "dazzling, stumble upon"
  ````
- **Files app (macOS/iOS)**: you can also open `quick.jsonl` and paste a line in the schema above.

---

## üß™ Test data
Append a test line (iPhone/iPad/Mac):
```json
{"ts":"2025-10-21 12:00:00","src":"quick","entries":"broccoli, stir-fry, paprika"}
```
Run the pipeline and confirm new Anki notes arrive with pt‚ÄëPT C1+ sentences.

---

## ü§ñ Model choice & quality
- **Default**: `OPENAI_MODEL=gpt-5-thinking` (high quality, C1+ tone, safest for nuance).
- **Cost‚Äësaver**: set `OPENAI_MODEL=gpt-mini` for cheap test runs, **but** expect simpler phrasing and occasional errors with idioms. Given your preference for **C1+ European Portuguese**, stick with a **higher‚Äëquality** model for production runs.
- The transformer enforces **pt‚ÄëPT**, adds **contextual example sentences**, and does **duplicate detection** against existing notes via AnkiConnect before insertion.

---

## üßØ Troubleshooting
- **File is created in the wrong folder** (e.g., ‚ÄúiCloud Drive‚Äù under `CloudStorage`): re‚Äëpoint Shortcuts to the **exact** Mobile Documents path above; disable ‚ÄúAsk Where to Save‚Äù in any Save/Append actions.
- **Multiple quick.jsonl files** (e.g., `quick 2.jsonl`): you used ‚ÄúSave File‚Äù instead of ‚ÄúGet File + Append‚Äù. Replace with the recipe in **iPhone/iPad** section.
- **No notes appear in Anki**: open Anki first; in Preferences ‚Üí Network confirm AnkiConnect is enabled; check `$ANKI_BASE/logs/autorun.err.log`.
- **Weird quotes / encoding**: the transformer normalizes UTF‚Äë8 and smart quotes; if a line still breaks, it will be logged and skipped.
- **Duplicates**: expected behavior is **skip**; switch to ‚Äúupdate‚Äëin‚Äëplace‚Äù mode later if you want edits.

---

## üìã Command reference
- Manual transform:
  ```bash
  python3 ~/anki-tools/scripts/transform_inbox_to_csv.py     --deck "Portuguese (pt-PT)" --model "GPT Vocabulary Automater"
  ```
- Full pipeline:
  ```bash
  bash ~/anki-tools/scripts/run_pipeline.sh
  ```
- Reload launchd:
  ```bash
  launchctl unload ~/anki-tools/launchd/com.anki.sync.quickjsonl.plist 2>/dev/null || true
  launchctl load   ~/anki-tools/launchd/com.anki.sync.quickjsonl.plist
  ```

---

## üó∫Ô∏è Decisions & rationale (what changed and why)
1. **Standardized path to Mobile Documents**  
   - **Included**: `/Users/koossimons/Library/Mobile Documents/com~apple~CloudDocs/Portuguese/Anki`  
   - **Removed**: `~/Library/CloudStorage/iCloud Drive/...` from the short README.  
   - **Why**: You explicitly asked to use **Mobile Documents**; Shortcuts and Files resolve this path consistently across devices and avoid accidental parallel folders.

2. **Single inbox file `quick.jsonl`**  
   - **Included** as the **only** canonical append target.  
   - **Why**: Prevents fragmentation and ‚Äúwhich file did I write to?‚Äù issues. Fragments are still **supported** but are merged by the pipeline (optional), so the main workflow remains simple.

3. **Explicit iPhone/iPad Shortcut recipe**  
   - **Included** detailed, step‚Äëby‚Äëstep actions (Ask for Input ‚Üí Date ‚Üí Text ‚Üí Get File ‚Üí Append).  
   - **Why**: Your earlier attempts created multiple files or overwrote content; this exact sequence keeps a stable handle to **one file** and appends with a trailing newline.

4. **Agent/Model guidance (C1+ pt‚ÄëPT)**  
   - **Included** a clear **OPENAI_MODEL** env and guidance.  
   - **Why**: You prefer **C1+ European Portuguese** quality; `gpt-mini` works for smoke tests but is not ideal for production.

5. **Anki template TTS (Joana voice)**  
   - **Included** `{{tts pt_PT voices=Joana:sentence_pt}}` in the README rather than generating audio files.  
   - **Why**: Matches your previous request; keeps the pipeline stateless and lets Anki generate audio on the fly.

6. **LaunchAgent schedule**  
   - **Included** `com.anki.sync.quickjsonl.plist` (09:00 daily) and load/unload commands.  
   - **Why**: You wanted true automation on Mac; the prior shorter README mentioned a schedule but lacked the working plist example.

7. **Kept your older CLI run example**  
   - **Included** the **system Python** one‚Äëliner, **and** the wrapper `run_pipeline.sh`.  
   - **Why**: Retains familiarity and offers a safer, logged runner.

8. **Troubleshooting & logs**  
   - **Included** precise failure locations and typical misconfigurations.  
   - **Why**: Reflects the recurring issues you hit (paths, duplicate files, missing Anki).

---

## ‚úÖ Summary
- **One path** across devices, one **append‚Äëonly** inbox.  
- **Step‚Äëby‚Äëstep** Shortcut ensures iOS/iPadOS writes to the **right file**.  
- Pipeline **enriches, translates, dedupes**, and inserts via AnkiConnect.  
- **C1+ pt‚ÄëPT** output favored; logs and archives make it auditable.

Created & maintained by **Koos Simons üáµüáπ**
